<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket Chat Tester</title>
</head>
<body>
  <h1>WebSocket Chat Tester</h1>

  <label>Login: <input type="text" id="login" value="alice"></label>
  <button onclick="connect()">Подключиться</button>
  <button onclick="disconnect()">Отключиться</button>
  <br><br>

  <label>Active Chat ID: <input type="text" id="chatId" /></label>
  <button onclick="setActiveChat()">Set Active Chat</button>
  <br><br>

  <label>Message: <input type="text" id="messageText" /></label>
  <label>Recipient Login: <input type="text" id="recipientLogin" /></label>
  <button onclick="sendMessage()">Send Message</button>
  <br><br>

  <pre id="log" style="background: #eee; padding: 10px; height: 300px; overflow: auto;"></pre>

  <script>
    let socket;

    function log(msg) {
      const logElem = document.getElementById("log");
      logElem.textContent += msg + "\n";
      logElem.scrollTop = logElem.scrollHeight;
    }

    function connect() {
      const login = document.getElementById("login").value;
      if (!login) {
        log("Введите login перед подключением");
        return;
      }

      socket = new WebSocket("ws://localhost:8081/chat?login=" + encodeURIComponent(login));

      socket.onopen = () => log("WebSocket connection opened");
      socket.onmessage = (event) => log("Received: " + event.data);
      socket.onclose = () => log("WebSocket connection closed");
      socket.onerror = (error) => log("Error: " + JSON.stringify(error));
    }

    function disconnect() {
      if (socket) {
        socket.close();
        socket = null;
        log("WebSocket manually disconnected");
      }
    }

    function setActiveChat() {
      const login = document.getElementById("login").value;
      const chatId = parseInt(document.getElementById("chatId").value, 10);

      if (!login || !chatId) {
        log("Введите login и ChatID");
        return;
      }

      const event = {
        eventType: "set_active_chat",
        data: {
          login: login,
          chat_id: chatId
        }
      };

      socket.send(JSON.stringify(event));
      log("Sent set_active_chat: " + JSON.stringify(event));
    }

    function sendMessage() {
      const login = document.getElementById("login").value;
      const messageText = document.getElementById("messageText").value;
      const recipientLogin = document.getElementById("recipientLogin").value;
      const chatId = parseInt(document.getElementById("chatId").value, 10);

      if (!login || !messageText || !recipientLogin || !chatId) {
        log("Введите все поля для отправки сообщения");
        return;
      }

      const event = {
        eventType: "send_message",
        data: {
          chat_id: chatId,
          sender_login: login,
          recipient_login: recipientLogin,
          content: messageText,
          created_at: new Date().toISOString()
        }
      };

      socket.send(JSON.stringify(event));
      log("Sent send_message: " + JSON.stringify(event));
    }
  </script>
</body>
</html>
